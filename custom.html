<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOOM - Custom WAD Launcher</title>
    <style type="text/css">
        .dosbox-container { width: 640px; height: 400px; }
        .dosbox-container > .dosbox-overlay { background: url(https://js-dos.com/cdn/DOOM.png); }
    </style>
</head>
<body>
    <header>
        <h1>Launch Custom DOOM WAD</h1>
    </header>

    <main>
        <label for="wad-upload">Select a WAD or ZIP file:</label>
        <input type="file" id="wad-upload" accept=".wad,.zip">
        <br/>
        <div id="dosbox-container" class="dosbox-container"></div>
        <button onclick="dosbox.requestFullScreen();">Make Fullscreen</button>
    </main>

    <script src="https://js-dos.com/cdn/js-dos-api.js"></script>
    <script>
        var dosbox;
        
        // Initialize Dosbox container
        function initializeDosbox(file) {
            if (dosbox) {
                dosbox.destroy(); // Destroy any existing instance
            }

            dosbox = new Dosbox({
                id: "dosbox-container",
                onload: function(dosbox) {
                    console.log("Loaded js-dos, ready to run WAD.");
                    // Run the uploaded WAD file
                    dosbox.run(file, "DOOM.EXE");
                },
                onrun: function(dosbox, app) {
                    console.log("App '" + app + "' is running");
                },
                onerror: function(error) {
                    console.error("Error:", error);
                }
            });
        }

        // Handle WAD file selection
        document.getElementById('wad-upload').addEventListener('change', function(event) {
            var file = event.target.files[0];

            if (file) {
                var reader = new FileReader();
                
                // Read the file as an ArrayBuffer (needed for js-dos)
                reader.onload = function(e) {
                    var wadData = e.target.result;

                    // Convert the file to a virtual file system for DOSBox
                    var fs = new JSZip();
                    fs.loadAsync(wadData).then(function(zip) {
                        // Upload the file to js-dos
                        var wadFileName = file.name.toLowerCase().endsWith('.zip') ? file.name : 'DOOM.WAD';
                        var wadFile = zip.file(wadFileName);

                        if (wadFile) {
                            // Create a temporary file system for the WAD
                            fs.file(wadFileName).async("blob").then(function(content) {
                                // Start DOSBox with the WAD content
                                var wadBlob = content;
                                dosbox.loadFile(wadBlob);
                                initializeDosbox(wadFileName);
                            });
                        }
                    });
                };
                reader.readAsArrayBuffer(file);
            }
        });
    </script>

    <footer>
        <p>&copy; 2024 Doom Launcher. Doom is a trademark of id Software.</p>
    </footer>
</body>
</html>
