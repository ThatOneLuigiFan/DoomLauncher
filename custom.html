<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOOM - Custom WAD Launcher</title>
    <style type="text/css">
        .dosbox-container { width: 640px; height: 400px; }
        .dosbox-container > .dosbox-overlay { background: url(https://js-dos.com/cdn/DOOM.png); }
    </style>
</head>
<body>
    <header>
        <h1>Launch Custom DOOM WAD</h1>
    </header>

    <main>
        <label for="wad-upload">Select a WAD or ZIP file:</label>
        <input type="file" id="wad-upload" accept=".wad,.zip">
        <br/>
        <div id="dosbox-container" class="dosbox-container"></div>
        <button onclick="dosbox.requestFullScreen();">Make Fullscreen</button>
    </main>

    <script src="https://js-dos.com/cdn/js-dos-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.8.0/jszip.min.js"></script>
    <script>
        var dosbox;

        // Initialize Dosbox container
        function initializeDosbox(wadFileName) {
            if (dosbox) {
                dosbox.destroy(); // Destroy any existing instance
            }

            dosbox = new Dosbox({
                id: "dosbox-container",
                onload: function(dosbox) {
                    console.log("Loaded js-dos, ready to run WAD.");
                    // Run the uploaded WAD file
                    dosbox.run(wadFileName, "DOOM.EXE");
                },
                onrun: function(dosbox, app) {
                    console.log("App '" + app + "' is running");
                },
                onerror: function(error) {
                    console.error("Error:", error);
                }
            });
        }

        // Handle WAD file selection
        document.getElementById('wad-upload').addEventListener('change', function(event) {
            var file = event.target.files[0];

            if (file) {
                var reader = new FileReader();

                // Read the file as an ArrayBuffer (needed for js-dos)
                reader.onload = function(e) {
                    var wadData = e.target.result;

                    // Check if it's a ZIP file
                    if (file.name.toLowerCase().endsWith('.zip')) {
                        // It's a ZIP file, so we need to extract it using JSZip
                        var zip = new JSZip();
                        zip.loadAsync(wadData).then(function(contents) {
                            var wadFile = zip.file("DOOM.WAD");
                            if (wadFile) {
                                // Upload the WAD file to js-dos
                                wadFile.async("blob").then(function(content) {
                                    // Create a virtual file system and load the WAD into it
                                    var wadBlob = content;
                                    dosbox.loadFile(wadBlob);
                                    initializeDosbox("DOOM.WAD");
                                });
                            } else {
                                console.error("DOOM.WAD not found in the ZIP file");
                            }
                        }).catch(function(error) {
                            console.error("Error loading ZIP file:", error);
                        });
                    } else {
                        // It's a .wad file, handle it directly
                        var blob = new Blob([wadData], { type: "application/octet-stream" });
                        dosbox.loadFile(blob);
                        initializeDosbox(file.name);
                    }
                };

                // Read the file as ArrayBuffer
                reader.readAsArrayBuffer(file);
            }
        });
    </script>

    <footer>
        <p>&copy; 2024 Doom Launcher. Doom is a trademark of id Software.</p>
    </footer>
</body>
</html>
